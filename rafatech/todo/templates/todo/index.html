{% extends 'home.html' %}
{% block content %}

<div id="myDIV" class="container">
    <!-- auto populated by script add_node function  --!>
        </div>

        <div class="container">
        <div class="row">

        <input type="text" id="masterBar" placeholder="New Todo ..." class ="bg-dark h3 w-100 text-white">
        </div>
        <div class="row">
        <div class="col-md-6">
        <div id="todo_container"></div>
        </div>
        <div class="col-md-6 ">
        <!-- Place for Clock!  -->
    <div class="container">
        <div class="row text-align-center" style="font-size: 50px">
            <div class="text-white col-md-6" id = "minute_time_remain" style="display: inline; text-align: right">25</div>
            <div class="text-white col-md-1" id = "time_seperator" style="display: inline">:</div>
            <div class="text-white col-md-5" id = "second_time_remain" style="display: inline; text-align: left">00</div>
        </div>
        <div class="row">
            <div class="btn-group" role="group" aria-label="work-control">
                <button id="start_timer" class="btn btn-secondary bg-dark" onclick="init_work()" >start</button>
                <button id="stop_timer" class="btn btn-secondary bg-dark" onclick="stop_work()" >stop</button>
                <button id="break_timer" class="btn btn-secondary bg-dark" onclick="break_work()" >break</button>
                <button id="finish_task" class="btn btn-secondary bg-dark" >task done</button>
                <button id="add_minute" class="btn btn-secondary bg-dark" onclick="add_min()">add minute</button>
            </div>
        </div>
        <div class="">
<br>
<br>
<h2 id="task_container" class="text-white border-bottom border-white">currently working on</h2>
            </div>
        </div>
        
        <h5>
            <span id="importance" class="badge badge-secondary bg-warning m-1">importance</span>
            <span id="time" class="badge badge-secondary bg-danger">time</span>
            <span id="due_date" class="badge badge-secondary bg-primary">due_date</span>
        </h5>
    </div>
        </div>
        </div>
        </div>


        <script>
            //communication with the server:
            var breaks_taken = 0;
            var work_time = 25;
            document.getElementById("minute_time_remain").innerHTML = work_time
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
            var yyyy = today.getFullYear();
            today = mm + '/' + dd + '/' + yyyy
            var current_mode = "stop" //designed to contain start stop or break
            //timer init 

            min_tr = document.getElementById("minute_time_remain")
            s_tr = document.getElementById("second_time_remain")

            var tickerVar
            b_start = document.getElementById("start_timer")
            b_stop = document.getElementById("stop_timer")
            b_break = document.getElementById("break_timer")
            b_finish = document.getElementById("finish_timer")
            b_add = document.getElementById("add_minute")


            function init_work(){
                if (current_mode == "start"){
                    console.log("should already be running")
                } else if (current_mode == "stop"){
                    console.log("stop ended starting timer")
                    tickervar = setInterval(tick, 1000)
                    current_mode = "start"
                } else if (current_mode == "break"){
                    console.log("skipping_break starting normal timer")
                    current_mode = "break"
                    min_tr.innerHTML = work_time 
                    s_tr.innerHTML = 00
                }
                b_start.classList.remove("bg-dark")
                b_start.classList.add("bg-success")
                b_stop.classList.remove("bg-danger")
                b_break.classList.remove("bg-warning")
                b_stop.classList.add("bg-dark")
                b_break.classList.add("bg-dark")
            }
            function stop_work(){
                if (current_mode == "start"){
                    console.log("stopping ongoing work")
                    clearInterval(tickervar);
                    current_mode = "stop"
                    min_tr.innerHTML = work_time 
                    s_tr.innerHTML = 00
                } else if (current_mode == "stop"){
                    console.log("already stopped, not doing anythin")
                    min_tr.innerHTML = work_time 
                    s_tr.innerHTML = 00
                } else if (current_mode == "break"){
                    console.log("stopping break")
                    min_tr.innerHTML = work_time 
                    s_tr.innerHTML = 00
                    clearInterval(tickervar);
                    current_mode = "stop"
                }
                b_stop.classList.remove("bg-dark")
                b_stop.classList.add("bg-danger")
                b_break.classList.remove("bg-warning")
                b_break.classList.add("bg-dark")
                b_start.classList.remove("bg-success")
                b_start.classList.add("bg-dark")
            }

            function done_work(){
                
            }
            function break_work(t=5){
                if (current_mode == "start"){
                    console.log("ending work starting break")
                    min_tr.innerHTML = t 
                    s_tr.innerHTML = 00
                    current_mode = "break"

                } else if (current_mode == "stop"){
                    console.log("starting break timer")
                    min_tr.innerHTML = t 
                    s_tr.innerHTML = 00
                    tickervar = setInterval(tick, 1000); 
                    current_mode = "break"
                } else if (current_mode == "break"){
                    console.log("already on a break. Not doing anything")
                }

                b_start.classList.remove("bg-success")
                b_stop.classList.remove("bg-danger")
                b_break.classList.remove("bg-dark")
                b_start.classList.add("bg-dark")
                b_stop.classList.add("bg-dark")
                b_break.classList.add("bg-warning")
                min_tr.innerHTML = t;
                s_tr.innerHTML = 0;
            }

            function tick(){
                if(s_tr.innerHTML == 0 && min_tr.innerHTML == 0){
                    console.log(s_tr.innerHTML)
                    console.log(min_tr.innerHTML)
                    window.clearInterval(tickerVar)
                }else if(min_tr.innerHTML > 0 && s_tr.innerHTML <= 0  ){
                    s_tr.innerHTML = 59; 
                    min_tr.innerHTML = min_tr.innerHTML - 1; 
                }else if(s_tr.innerHTML >= 0 && min_tr.innerHTML >= 0 ){
                    s_tr.innerHTML = s_tr.innerHTML - 1 
                }
            }

            function parse_input_box(event){
                bar = document.getElementById("masterBar")
                importance_regex = "([P])[0-9]\\s"
                required_time_regex = "([D])[0-9]\\s"
                try{importance = bar.value.match(importance_regex)[0].replace(" ", "").replace("P","")} catch{importance=0}
                try{required_time = bar.value.match(required_time_regex)[0].replace(" ", "").replace("D","")} catch{required_time=1}
                todo_name = bar.value.replace(importance_regex, "")
                console.log(`importance is ${importance} and required time is ${required_time}`)
                if (event.keyCode == 13 ) {
                    console.log('Enter pressed')
                    create_task(todo_name,today,  importance,required_time)
                } else /* fullscreenerror */ {
                    /* handle a full screen toggle error */
                }
            }   

            function add_node (todo_name,todo_id,importance=0,due_date=today, required_time=1 ){
                inner_html = 
                    ` 

        <div class="btn-group w-100" role="group">
            <button type="button"class="btn btn-dark" todo_id="${todo_id}" onclick="check_off(event,${todo_id},'o')">
                <i class="fa-hammer fas"></i>
            </button>
            <button type = "button"class="btn P2 col-10 bg-dark text-white" todo_id="${todo_id}" due_date="${due_date}" required_time="${required_time}">
                ${todo_name}
            </button>
            <button type="button"class="btn btn-dark " todo_id="${todo_id}" onclick="delete_todo(event, ${todo_id})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `
                cont = document.getElementById("todo_container")
                l = document.createElement('div')
                l.classList.add("container");
                l.classList.add("border-bottom");
                l.classList.add("pb-1");
                l.id = todo_id
                l.innerHTML = inner_html 
                cont.appendChild(l)


            }

            document.getElementById("todo_container").childNodes[0]
var out
function get_details(todo_id){

                var http = new XMLHttpRequest();
    var url = `/todo/detail/${todo_id}.json`
                http.open("GET", url, true);

    http.onreadystatechange = function(){
                    if(http.readyState == 4 && http.status == 200) {
data = JSON.parse(this.response)
                        console.log(data[0].fields["todo_name"])
                        document.getElementById("task_container").innerText = data[0].fields["todo_name"]
                        document.getElementById("task_container").setAttribute("todo_id", todo_id)
                        document.getElementById("importance").innerText = data[0].fields["importance"]
                        document.getElementById("time").innerText = data[0].fields["required_time"]
                        document.getElementById("due_date").innerText = data[0].fields["due_date"]
                    }

                }
                http.send(null);
}
            function check_off(event, todo_id, new_status ){
                console.log("checked")
                nodes = document.getElementById("todo_container").childNodes
                l_nodes = nodes.length

                for (let l of nodes) {
                    console.log(l);
                    l.classList.remove("border-warning")
                }

                var url = `/todo/status/${todo_id}`;
                var params = `status=${new_status}`;
                var http = new XMLHttpRequest();

                http.open("GET", url+"?"+params, true);

                http.onreadystatechange = function(){
                    if(http.readyState == 4 && http.status == 200) {
                        document.getElementById(todo_id).classList.add("border-warning")
                        get_details(todo_id)

                    }
                }
                http.send(null);
            } 
function add_min(){
    document.getElementById("minute_time_remain").innerText = Number(document.getElementById("minute_time_remain").innerText) + 1
}
function finish_todo(){
    todo_id = document.getElementById("task_container").getAttribute("todo_id"); 
    
} 
function delete_todo(event, todo_id){
    console.log(`deleting ${todo_id}`)
    var delete_url = `/todo/delete/${todo_id}`;
    var http = new XMLHttpRequest();
    if (confirm("Are you sure?")){
        http.open("GET", delete_url);

        http.onreadystatechange = function()
        {
            if(http.readyState == 4 && http.status == 200) {
                document.getElementById(todo_id).remove()
            }
        }
        http.send(null);}

}


            document.getElementById("masterBar").addEventListener("keydown", parse_input_box);
            function create_task(todo_name,due_date=today,importance=0,required_time=1){
                var url = "/todo/new";
                var params = `todo_name=${todo_name}&due_date=${due_date}&importance=${importance}&required_time=${required_time}`;
                var http = new XMLHttpRequest();

                http.open("GET", url+"?"+params, true);
                http.onreadystatechange = function()
                {
                    if(http.readyState == 4 && http.status == 200) {
                        add_node(todo_name, http.responseText, importance, due_date, required_time)
                    }
                }
                http.send(null);
            }

            {% for todo in todo_list %}

            add_node("{{todo.todo_name}}i",  "{{todo.todo_id}}", "{{todo.importance}}", "{{todo.due_date}}","{{todo.required_time}}")  
            {% endfor %}
        </script>
        {% endblock %}
